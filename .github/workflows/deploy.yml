# ============================================================
# Cloudflare Workers ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ============================================================
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€Backendï¼ˆHono.jsï¼‰ã¨Frontendï¼ˆNext.js + OpenNextï¼‰ã‚’
# Cloudflare Workersã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
#
# ä¸»ãªæ©Ÿèƒ½:
# - Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹é«˜é€Ÿãƒ“ãƒ«ãƒ‰
# - OpenNextèª¤æ¤œå‡ºã®å›é¿ï¼ˆãƒ¢ãƒãƒ¬ãƒå¯¾å¿œï¼‰
# - R2ãƒã‚±ãƒƒãƒˆã®ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
# - ä¸¦åˆ—ã‚¸ãƒ§ãƒ–å®Ÿè¡Œã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“çŸ­ç¸®
# ============================================================

name: Deploy to Cloudflare Workers

# ============================================================
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# ============================================================
# masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
#
# paths-ignoreã®èª¬æ˜:
# - ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—
# - README.md: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
# - docs/: AIç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
# - .claude/: Claude Codeè¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
# - *.md: ã™ã¹ã¦ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ«ãƒ¼ãƒˆéšå±¤ï¼‰
#
# æ³¨æ„:
# - paths-ignoreã«è©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€Œã®ã¿ã€ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã‚¹ã‚­ãƒƒãƒ—
# - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åŒæ™‚ã«å¤‰æ›´ã—ãŸå ´åˆã¯é€šå¸¸é€šã‚Šãƒ‡ãƒ—ãƒ­ã‚¤
#
# æ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦ãªå ´åˆã¯ã€workflow_dispatchã‚’è¿½åŠ ã—ã¦ãã ã•ã„:
#   on:
#     push:
#       branches: [master]
#       paths-ignore: [...]
#     workflow_dispatch:
# ============================================================
on:
  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - 'AIç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/**'
      - 'Screenshots/**'
      - 'docs/**'
      - '.claude/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  # ============================================================
  # Job 1: Backend Worker ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  # ============================================================
  # Hono.jsã§æ§‹ç¯‰ã•ã‚ŒãŸAPIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
  # ============================================================
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend Worker
    steps:
      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ----------------------------------------------------------
      # ç›®çš„: GitHub Actionsãƒ©ãƒ³ãƒŠãƒ¼ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      # actions/checkout@v4: æœ€æ–°ã®å®‰å®šç‰ˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      # ----------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—2: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ----------------------------------------------------------
      # ç›®çš„: Node.js 20ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
      #
      # cache: 'pnpm' ã®åŠ¹æœ:
      # - node_modules/ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è‡ªå‹•ç®¡ç†
      # - pnpm-lock.yamlã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
      # - 2å›ç›®ä»¥é™ã®ãƒ“ãƒ«ãƒ‰ãŒå¤§å¹…ã«é«˜é€ŸåŒ–ï¼ˆç´„30-60%çŸ­ç¸®ï¼‰
      # ----------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—3: Turborepoãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      # ----------------------------------------------------------
      # ç›®çš„: Turborepoã®.turbo/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é«˜é€ŸåŒ–
      #
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥:
      # - key: ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆå°‚ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå³å¯†ä¸€è‡´ï¼‰
      # - restore-keys: å‰å›ã®ãƒ“ãƒ«ãƒ‰çµæœã‚’å†åˆ©ç”¨ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
      #
      # åŠ¹æœ:
      # - TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã®å†åˆ©ç”¨
      # - ãƒªãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆçµæœã®å†åˆ©ç”¨
      # - ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’æœ€å¤§80%çŸ­ç¸®
      # ----------------------------------------------------------
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—4: pnpmä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ----------------------------------------------------------
      # ç›®çš„: pnpm-lock.yamlã«åŸºã¥ã„ã¦å³å¯†ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      #
      # pnpm install --frozen-lockfile ã®ç‰¹å¾´:
      # - pnpm install ã‚ˆã‚Šé«˜é€Ÿï¼ˆç´„2-3å€ï¼‰
      # - node_modules/ ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # - pnpm-lock.yamlã¨å®Œå…¨ä¸€è‡´ã‚’ä¿è¨¼ï¼ˆå†ç¾æ€§ãŒé«˜ã„ï¼‰
      # - CI/CDç’°å¢ƒã«æœ€é©åŒ–
      #
      # æ³¨æ„: ãƒ¢ãƒãƒ¬ãƒã®ãŸã‚ã€ãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œã™ã‚‹ã¨ã™ã¹ã¦ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«é©ç”¨ã•ã‚Œã¾ã™
      # ----------------------------------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—5: API Workerã®å‹ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ“ãƒ«ãƒ‰
      # ----------------------------------------------------------
      # ç›®çš„: TypeScriptã®å‹ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã€ãƒ“ãƒ«ãƒ‰æˆåŠŸã‚’ç¢ºèª
      #
      # working-directory: ./apps/api
      # - apps/apiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
      #
      # pnpm run build ã®å†…å®¹ï¼ˆapps/api/package.jsonå‚ç…§ï¼‰:
      # - TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆtsconfig.jsonã«åŸºã¥ãï¼‰
      # - å‹ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã“ã“ã§å¤±æ•—ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ–­
      # ----------------------------------------------------------
      - name: Type check API
        working-directory: ./apps/api
        run: pnpm run build

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—6: OpenNextãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¸€æ™‚çš„ãªéš è”½
      # ----------------------------------------------------------
      # ç›®çš„: Wranglerã®èª¤æ¤œå‡ºã‚’é˜²ãï¼ˆãƒ¢ãƒãƒ¬ãƒç‰¹æœ‰ã®å•é¡Œï¼‰
      #
      # èƒŒæ™¯:
      # - Wranglerã¯node_modules/@opennextjsã®å­˜åœ¨ã‚’æ¤œå‡ºã™ã‚‹ã¨ã€
      #   ã™ã¹ã¦ã®Workerã‚’OpenNextãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ãŠã†ã¨ã™ã‚‹
      # - apps/apiã¯ç´”ç²‹ãªHono Workerãªã®ã§ã€èª¤æ¤œå‡ºã•ã‚Œã‚‹ã¨å¤±æ•—ã™ã‚‹
      #
      # è§£æ±ºç­–:
      # - ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ä¸€æ™‚çš„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’å¤‰æ›´
      # - @opennextjs â†’ @opennextjs-hidden
      # - Wranglerã®æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰éš ã™
      #
      # å‚è€ƒ: Wranglerã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã“ã®å•é¡Œã®è¨˜è¼‰ãªã—ï¼ˆç‹¬è‡ªå¯¾å¿œï¼‰
      # ----------------------------------------------------------
      - name: Temporarily hide OpenNext package from API
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªãƒãƒ¼ãƒ 
          if [ -d "node_modules/@opennextjs" ]; then
            mv node_modules/@opennextjs node_modules/@opennextjs-hidden
            echo "âœ“ OpenNext package hidden successfully"
          else
            echo "âš  OpenNext package not found (skipping)"
          fi

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—7: Backend Workerã®ãƒ‡ãƒ—ãƒ­ã‚¤
      # ----------------------------------------------------------
      # ç›®çš„: Hono.js APIã‚’Cloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤
      #
      # cloudflare/wrangler-action@v3:
      # - Cloudflareå…¬å¼ã®Wranglerã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      # - Wrangler CLIã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å®Ÿè¡Œ
      #
      # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
      # - apiToken: Cloudflare APIèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆRepository Secretsã‹ã‚‰å–å¾—ï¼‰
      # - accountId: Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆRepository Secretsã‹ã‚‰å–å¾—ï¼‰
      # - workingDirectory: apps/apiï¼ˆwrangler.jsoncã®å ´æ‰€ï¼‰
      # - command: deploy --minifyï¼ˆã‚³ãƒ¼ãƒ‰æœ€å°åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ããƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
      #
      # ç’°å¢ƒå¤‰æ•°:
      # - CLOUDFLARE_API_TOKEN: Wranglerå†…éƒ¨ã§ä½¿ç”¨
      # - CLOUDFLARE_ACCOUNT_ID: Wranglerå†…éƒ¨ã§ä½¿ç”¨
      # - NODE_ENV: productionï¼ˆæœ¬ç•ªç’°å¢ƒãƒ¢ãƒ¼ãƒ‰ï¼‰
      #
      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ:
      # - Workerå: portfolio-apiï¼ˆapps/api/wrangler.jsoncã§å®šç¾©ï¼‰
      # - URL: portfolio-api.<subdomain>.workers.dev
      # ----------------------------------------------------------
      - name: Deploy Backend Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'apps/api'
          command: deploy --minify
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NODE_ENV: production

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—8: OpenNextãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¾©å…ƒ
      # ----------------------------------------------------------
      # ç›®çš„: æ¬¡ã®ã‚¸ãƒ§ãƒ–ï¼ˆdeploy-webï¼‰ã®ãŸã‚ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…ƒã«æˆ»ã™
      #
      # if: always()
      # - å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚å¿…ãšå®Ÿè¡Œ
      # - ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã«ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¿è¨¼
      #
      # ç†ç”±:
      # - GitHub Actionsã¯åŒã˜ãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ã„å›ã™å¯èƒ½æ€§ãŒã‚ã‚‹
      # - æ¬¡å›å®Ÿè¡Œæ™‚ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      # ----------------------------------------------------------
      - name: Restore OpenNext package
        if: always()
        run: |
          # éš è”½ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å¾©å…ƒ
          if [ -d "node_modules/@opennextjs-hidden" ]; then
            mv node_modules/@opennextjs-hidden node_modules/@opennextjs
            echo "âœ“ OpenNext package restored successfully"
          else
            echo "âš  Hidden package not found (skipping)"
          fi

  # ============================================================
  # Job 2: Frontend Worker ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  # ============================================================
  # Next.js + OpenNextã§æ§‹ç¯‰ã•ã‚ŒãŸWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
  #
  # æ³¨æ„: deploy-backendã‚¸ãƒ§ãƒ–ã¨ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã¾ã™
  # ============================================================
  deploy-web:
    runs-on: ubuntu-latest
    name: Deploy Web Worker
    steps:
      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ----------------------------------------------------------
      # ç›®çš„: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆBackend jobã¨åŒã˜ï¼‰
      #
      # æ³¨æ„: å„ã‚¸ãƒ§ãƒ–ã¯ç‹¬ç«‹ã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€
      #       Backend jobã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦ã„ã¦ã‚‚å†åº¦å¿…è¦
      # ----------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—2: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ----------------------------------------------------------
      # ç›®çš„: Node.js 20ã¨pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆBackend jobã¨åŒã˜ï¼‰
      # ----------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—3: Turborepoãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      # ----------------------------------------------------------
      # ç›®çš„: Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒï¼ˆBackend jobã¨åŒã˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼‰
      #
      # ä¸¦åˆ—ã‚¸ãƒ§ãƒ–ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‹•ä½œ:
      # - Backend jobã¨Web jobã¯ç•°ãªã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ã§å®Ÿè¡Œ
      # - åŒã˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å…ˆã«å®Œäº†ã—ãŸã‚¸ãƒ§ãƒ–ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
      # - æ¬¡å›å®Ÿè¡Œæ™‚ã«ä¸¡æ–¹ã®ã‚¸ãƒ§ãƒ–ãŒé«˜é€ŸåŒ–
      # ----------------------------------------------------------
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—4: Next.jsãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      # ----------------------------------------------------------
      # ç›®çš„: Next.jsã®.next/cacheãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      #
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡:
      # - apps/web/.next/cache/
      #   - Webpack/Turbopackã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      #   - ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœ
      #   - ç”»åƒæœ€é©åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      #
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼æ§‹æˆ:
      # - OSå (Linux)
      # - nextjs- ï¼ˆè­˜åˆ¥å­ï¼‰
      # - pnpm-lock.yamlã®ãƒãƒƒã‚·ãƒ¥ï¼ˆä¾å­˜é–¢ä¿‚ã®å¤‰æ›´æ¤œå‡ºï¼‰
      # - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´æ¤œå‡ºï¼‰
      #
      # restore-keys:
      # - å®Œå…¨ä¸€è‡´ã—ãªã„å ´åˆã€ä¾å­˜é–¢ä¿‚ãŒåŒã˜ãªã‚‰éƒ¨åˆ†ä¸€è‡´ã§å¾©å…ƒ
      #
      # åŠ¹æœ:
      # - åˆå›ãƒ“ãƒ«ãƒ‰: ç´„5-8åˆ†
      # - 2å›ç›®ä»¥é™: ç´„2-3åˆ†ï¼ˆ60%çŸ­ç¸®ï¼‰
      # ----------------------------------------------------------
      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.js', 'apps/web/**/*.jsx', 'apps/web/**/*.ts', 'apps/web/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—5: pnpmä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ----------------------------------------------------------
      # ç›®çš„: pnpm-lock.yamlã«åŸºã¥ã„ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      #
      # æ³¨æ„: ãƒ¢ãƒãƒ¬ãƒã®ãŸã‚ã€Backend jobã¨åŒã˜node_modules/ãŒä½œæˆã•ã‚Œã¾ã™
      # ----------------------------------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—6: R2ãƒã‚±ãƒƒãƒˆã®ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
      # ----------------------------------------------------------
      # ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«Next.js ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
      #
      # èƒŒæ™¯:
      # - Next.js ISRï¼ˆIncremental Static Regenerationï¼‰ã¯R2ãƒã‚±ãƒƒãƒˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
      # - å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚‚å¤ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã‚‹
      #
      # wrangler r2 object delete ã®å‹•ä½œ:
      # - --all: ãƒã‚±ãƒƒãƒˆå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
      # - next-cache-bucket: R2ãƒã‚±ãƒƒãƒˆåï¼ˆapps/web/wrangler.jsoncã§å®šç¾©ï¼‰
      #
      # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
      # - || echo "...": ãƒã‚±ãƒƒãƒˆãŒç©ºã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
      # - åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ãƒã‚±ãƒƒãƒˆãŒç©ºãªã®ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
      #
      # ç’°å¢ƒå¤‰æ•°:
      # - CLOUDFLARE_API_TOKEN: Wranglerèªè¨¼ç”¨
      # - CLOUDFLARE_ACCOUNT_ID: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè­˜åˆ¥ç”¨
      #
      # ä»£æ›¿æ¡ˆ:
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä¿æŒã•ã‚Œã¾ã™ã€‚
      # æ‰‹å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒå¿…è¦ãªå ´åˆã¯:
      #   Cloudflare Dashboard â†’ R2 â†’ next-cache-bucket â†’ Delete all
      # ----------------------------------------------------------
      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—7: Web Workerã®ãƒ“ãƒ«ãƒ‰
      # ----------------------------------------------------------
      # ç›®çš„: Next.jsã‚¢ãƒ—ãƒªã‚’OpenNextã§Cloudflare Workerså½¢å¼ã«å¤‰æ›
      #
      # pnpm run build:worker ã®å†…å®¹ï¼ˆapps/web/package.jsonã‚ˆã‚Šï¼‰:
      # - opennextjs-cloudflare build
      # - Next.jsã‚¢ãƒ—ãƒªã‚’è§£æ
      # - Cloudflare Workersç”¨ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
      # - .open-next/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å‡ºåŠ›
      #
      # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:
      # - .open-next/worker.js: Workerã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
      # - .open-next/assets/: é™çš„ã‚¢ã‚»ãƒƒãƒˆï¼ˆç”»åƒã€CSSã€JSï¼‰
      #
      # ãƒ—ãƒ­ã‚»ã‚¹:
      # 1. next buildï¼ˆNext.jsãƒ“ãƒ«ãƒ‰ï¼‰
      # 2. OpenNextå¤‰æ›ï¼ˆCloudflare Workersé©å¿œï¼‰
      # 3. ã‚³ãƒ¼ãƒ‰æœ€é©åŒ–ãƒ»ãƒãƒ³ãƒ‰ãƒ«
      #
      # ãƒ“ãƒ«ãƒ‰æ™‚é–“:
      # - åˆå›: ç´„5-8åˆ†
      # - ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨æ™‚: ç´„2-3åˆ†
      # ----------------------------------------------------------
      - name: Build Web Worker
        working-directory: ./apps/web
        run: pnpm run build:worker

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—8: Web Workerã®ãƒ‡ãƒ—ãƒ­ã‚¤
      # ----------------------------------------------------------
      # ç›®çš„: Next.js + OpenNextã‚’Cloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤
      #
      # cloudflare/wrangler-action@v3:
      # - Wrangler CLIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
      #
      # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
      # - apiToken: Cloudflare APIèªè¨¼ï¼ˆRepository Secretsï¼‰
      # - accountId: Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆRepository Secretsï¼‰
      # - workingDirectory: apps/webï¼ˆwrangler.jsoncã®å ´æ‰€ï¼‰
      # - command: deployï¼ˆ--minifyãªã—ã€OpenNextãŒæ—¢ã«æœ€é©åŒ–æ¸ˆã¿ï¼‰
      #
      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ:
      # - Workerå: homeï¼ˆapps/web/wrangler.jsoncã§å®šç¾©ï¼‰
      # - URL: home.<subdomain>.workers.dev
      #
      # Service Binding:
      # - è‡ªå‹•çš„ã«portfolio-api Workerã¨ãƒã‚¤ãƒ³ãƒ‰
      # - wrangler.jsoncã®servicesè¨­å®šãŒé©ç”¨ã•ã‚Œã‚‹
      #
      # R2 Binding:
      # - next-cache-bucketãŒè‡ªå‹•çš„ã«ãƒã‚¤ãƒ³ãƒ‰
      # - ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª­ã¿æ›¸ããŒå¯èƒ½ã«ãªã‚‹
      #
      # ç’°å¢ƒå¤‰æ•°:
      # - CLOUDFLARE_API_TOKEN: Wranglerèªè¨¼
      # - CLOUDFLARE_ACCOUNT_ID: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè­˜åˆ¥
      #
      # æ³¨æ„:
      # - ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ç’°å¢ƒå¤‰æ•°ã¯Cloudflare Dashboardã§è¨­å®šãŒå¿…è¦
      #   - INTERNAL_API_KEYï¼ˆSecretï¼‰
      #   - GITHUB_USERNAMEï¼ˆVariableï¼‰
      #   - ZENN_USERNAMEï¼ˆVariableï¼‰
      # ----------------------------------------------------------
      - name: Deploy Web Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'apps/web'
          command: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # ----------------------------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—9: R2ãƒã‚±ãƒƒãƒˆã®ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œï¼‰
      # ----------------------------------------------------------
      # ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å¤ã„ISRã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
      #
      # ãªãœãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‹ï¼š
      # - OpenNextã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’populateã™ã‚‹
      # - ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¯ãƒªã‚¢ã—ã¦ã‚‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å†ä½œæˆã•ã‚Œã‚‹
      # - ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã‚¯ãƒªã‚¢ã™ã‚‹ã“ã¨ã§ã€æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«
      #   æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”Ÿæˆã•ã‚Œã‚‹
      # ----------------------------------------------------------
      - name: Clear R2 ISR Cache (Post-Deploy)
        working-directory: ./apps/web
        run: |
          echo "ğŸ—‘ï¸  Clearing R2 ISR cache: next-cache-bucket/incremental-cache/"
          echo "ğŸ“‹ Installing AWS SDK..."
          pnpm add --no-save @aws-sdk/client-s3

          node << 'SCRIPT'
          const { S3Client, ListObjectsV2Command, DeleteObjectsCommand } = require('@aws-sdk/client-s3');

          console.log('ğŸ”§ Initializing S3 Client...');

          const client = new S3Client({
            region: 'auto',
            endpoint: `https://${process.env.CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com`,
            credentials: {
              accessKeyId: process.env.R2_ACCESS_KEY_ID,
              secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,
            },
          });

          async function deleteAllObjects() {
            const bucketName = 'next-cache-bucket';
            const prefix = 'incremental-cache/';

            console.log(`\nğŸ“¦ Bucket: ${bucketName}`);
            console.log(`ğŸ“ Prefix: ${prefix}`);

            let continuationToken = undefined;
            let totalDeleted = 0;

            do {
              try {
                const listCommand = new ListObjectsV2Command({
                  Bucket: bucketName,
                  Prefix: prefix,
                  ContinuationToken: continuationToken,
                  MaxKeys: 1000,
                });

                const listResponse = await client.send(listCommand);

                if (!listResponse.Contents || listResponse.Contents.length === 0) {
                  break;
                }

                const deleteCommand = new DeleteObjectsCommand({
                  Bucket: bucketName,
                  Delete: {
                    Objects: listResponse.Contents.map(obj => ({ Key: obj.Key })),
                  },
                });

                const deleteResponse = await client.send(deleteCommand);
                totalDeleted += (deleteResponse.Deleted?.length || 0);

                continuationToken = listResponse.IsTruncated ? listResponse.NextContinuationToken : undefined;

              } catch (error) {
                console.error('âŒ Error:', error.message);
                throw error;
              }
            } while (continuationToken);

            console.log(`\nâœ… ISR cache cleared! Deleted ${totalDeleted} objects`);
          }

          deleteAllObjects().catch(error => {
            console.error('ğŸ’¥ Failed:', error);
            process.exit(1);
          });
          SCRIPT
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
# ============================================================
# å¿…è¦ãªGitHub Secretsè¨­å®š
# ============================================================
# Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets
#
# å¿…é ˆ:
# - CLOUDFLARE_API_TOKEN: Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§API Tokenã‚’ç”Ÿæˆ
#   - Edit Cloudflare Workersæ¨©é™ãŒå¿…è¦
# - CLOUDFLARE_ACCOUNT_ID: Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®Account IDã‚’ã‚³ãƒ”ãƒ¼
# - R2_ACCESS_KEY_ID: R2 API Tokenã®Access Key ID
# - R2_SECRET_ACCESS_KEY: R2 API Tokenã®Secret Access Key
#
# è¨­å®šæ–¹æ³•:
# 1. Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ My Profile â†’ API Tokens â†’ Create Token
# 2. "Edit Cloudflare Workers" ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
# 3. Account Resources â†’ Include â†’ <your account>
# 4. Zone Resources â†’ Include â†’ All zones
# 5. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦GitHub Secretsã«ä¿å­˜
# ============================================================

# ============================================================
# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# ============================================================
#
# Q1: "OpenNext project detected" ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹
# A1: "Temporarily hide OpenNext package" ã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã›ã‚“
#     - node_modules/@opennextjsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
#     - mv ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ãƒ­ã‚°ã‚’ç¢ºèª
#
# Q2: R2ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒå¤±æ•—ã™ã‚‹
# A2: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
#     - CLOUDFLARE_API_TOKENã«R2æ¨©é™ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
#     - next-cache-bucketãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆåˆå›ã¯æ‰‹å‹•ä½œæˆãŒå¿…è¦ï¼‰
#
# Q3: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚‚å¤ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã‚‹
# A3: ä»¥ä¸‹ã®åŸå› ãŒè€ƒãˆã‚‰ã‚Œã¾ã™
#     - R2ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒå¤±æ•—ã—ã¦ã„ã‚‹ â†’ ãƒ­ã‚°ã‚’ç¢ºèª
#     - ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ Ctrl+F5ã§ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰
#     - Cloudflare CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ Dashboard â†’ Caching â†’ Purge Everything
#
# Q4: ãƒ“ãƒ«ãƒ‰ãŒé…ã„
# A4: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
#     - Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ â†’ ãƒ­ã‚°ã§ "cache hit" ã‚’ç¢ºèª
#     - Next.jsã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ â†’ .next/cache/ ã®å¾©å…ƒãƒ­ã‚°ã‚’ç¢ºèª
#     - ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‹ â†’ pnpm-lock.yaml ã®å·®åˆ†ã‚’ç¢ºèª
#
# Q5: Service BindingãŒå‹•ä½œã—ãªã„
# A5: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
#     - Backend Worker (portfolio-api) ãŒå…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹
#     - wrangler.jsoncã®servicesè¨­å®šãŒæ­£ã—ã„ã‹
#     - Cloudflare Dashboard â†’ Workers â†’ home â†’ Settings â†’ Bindings ã‚’ç¢ºèª
# ============================================================





